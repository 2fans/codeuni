import pexpect
import sys

# Device connection details
ip_address = '192.168.56.101'
username = 'tufan'
password = '123'
enable_password = '123'

# Start SSH session (auto accept host key)
ssh_command = f"ssh -o StrictHostKeyChecking=no {username}@{ip_address}"
session = pexpect.spawn(ssh_command, encoding='utf-8', timeout=20)

# 1. Expect login password prompt
index = session.expect(['[Pp]assword:', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print(f"--- FAILURE: SSH password prompt not found connecting to {ip_address}")
    sys.exit(1)

# 2. Send login password
session.sendline(password)
# Expect user exec prompt '>' or privileged '#'
index = session.expect(['[>#]', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print("--- FAILURE: after sending login password")
    sys.exit(1)

# 3. Enter enable mode if not already privileged
session.sendline('enable')
index = session.expect(['[Pp]assword:', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print("--- FAILURE: enable prompt not found")
    sys.exit(1)

# 4. Send enable password
session.sendline(enable_password)
index = session.expect(['#', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print("--- FAILURE: after sending enable password")
    sys.exit(1)

# 5. Enter global config mode
session.sendline('configure terminal')
index = session.expect(['\(config\)#', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print("--- FAILURE: entering config mode")
    sys.exit(1)

# 6. Change hostname to R1
session.sendline('hostname R1')
index = session.expect([r'R1\(config\)#', pexpect.TIMEOUT, pexpect.EOF])
if index != 0:
    print("--- FAILURE: setting hostname")
    sys.exit(1)

# 7. Exit config and privileged modes
session.sendline('end')  # exit configuration mode to privileged exec
session.sendline('exit') # exit privileged exec

# 8. Close SSH session
session.close()

print(f"--- SUCCESS: SSH to {ip_address} as {username}")
